



<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simple California Demo 2.0 &mdash; SHAP latest documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=7ab3649f" />
      <link rel="stylesheet" type="text/css" href="../../../_static/nbsphinx-code-cells.css?v=2aa19091" />
      <link rel="stylesheet" href="../../../_static/css/style.css" type="text/css" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=c6e86fd7"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Simple Kernel SHAP" href="Simple%20Kernel%20SHAP.html" />
    <link rel="prev" title="SHAP Values for Multi-Output Regression Models" href="Multioutput%20Regression%20SHAP.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #343131" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/shap_logo_white.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overviews.html">Topical overviews</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../tabular_examples.html">Tabular examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../tabular_examples.html#tree-based-models">Tree-based models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tabular_examples.html#linear-models">Linear models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tabular_examples.html#neural-networks">Neural networks</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../tabular_examples.html#model-agnostic">Model agnostic</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="Census%20income%20classification%20with%20scikit-learn.html">Census income classification with scikit-learn</a></li>
<li class="toctree-l3"><a class="reference internal" href="Diabetes%20regression.html">Diabetes regression with scikit-learn</a></li>
<li class="toctree-l3"><a class="reference internal" href="Iris%20classification%20with%20scikit-learn.html">Iris classification with scikit-learn</a></li>
<li class="toctree-l3"><a class="reference internal" href="Multioutput%20Regression%20SHAP.html">SHAP Values for Multi-Output Regression Models</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Simple California Demo 2.0</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Train-a-model">Train a model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Compute-a-hierarchical-clustering-of-the-input-features">Compute a hierarchical clustering of the input features</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Explain-the-instance">Explain the instance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Compare-to-Tree-SHAP">Compare to Tree SHAP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Plots-to-explain-the-instance">Plots to explain the instance</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="Simple%20Kernel%20SHAP.html">Simple Kernel SHAP</a></li>
<li class="toctree-l3"><a class="reference internal" href="Squashing%20Effect.html">How a squashing function can effect feature importance</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../text_examples.html">Text examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../image_examples.html">Image examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../genomic_examples.html">Genomic examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_examples.html">API examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmarks.html">Benchmarks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #343131" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">SHAP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../tabular_examples.html">Tabular examples</a></li>
      <li class="breadcrumb-item active">Simple California Demo 2.0</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/example_notebooks/tabular_examples/model_agnostic/Simple California Demo.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Simple-California-Demo-2.0">
<h1>Simple California Demo 2.0<a class="headerlink" href="#Simple-California-Demo-2.0" title="Link to this heading"></a></h1>
<p>This notebook shows how to use build a hierarchical clustering of the input features and use it to explain a single instance. It will showcase two method to do this:</p>
<p>The PartitionExplainer which creates a binary-hierarchal clustering of features using your choice of scipy clustering methods. The PartitionExplainer then caculates the feature attribution with the marginals respecting this binary partition tree. This is a good way to explain a single instance when the number of input features is large. When given a balanced partition tree PartitionExplainer has <span class="math notranslate nohighlight">\(O(M^2)\)</span> runtime, where <span class="math notranslate nohighlight">\(M\)</span> is the number of input features. This is much better than the
<span class="math notranslate nohighlight">\(O(2^M)\)</span> runtime of KernelExplainer.</p>
<p>The CoalitionExplainer allows more controll over the hierarchy of features. Users can specify any nested hierarchy of features as a dictionary. This means each node (group of features) gets allocated it’s marginal contribution to all of its siblings allowing for more than one. So the computational complexity at each level is <span class="math notranslate nohighlight">\(O(2^K)\)</span>, where <span class="math notranslate nohighlight">\(K\)</span> is the number of siblings, depends on the hierarchy of features specified. This method allows for more sensible explanations and a finer
grained evaluation of the working of the model.</p>
<p>To clarify jargon Shapley values treat all input features as the same. Owen values are values respecting coalitions of features. Recursive Owen values also sometimes called Winter values respect nested coalitions.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>  <span class="c1"># timing the methods</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>  <span class="c1"># visualising the feature coalition structure</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">scipy.cluster</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBRegressor</span>  <span class="c1"># The model we use is an XGBoost model</span>

<span class="kn">import</span> <span class="nn">shap</span>

<span class="n">seed</span> <span class="o">=</span> <span class="mi">2023</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\programming\shap\.venv\lib\site-packages\tqdm\auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div></div>
</div>
<section id="Train-a-model">
<h2>Train a model<a class="headerlink" href="#Train-a-model" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">california</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">subsample</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">instance</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
<span class="n">references</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">100</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="Compute-a-hierarchical-clustering-of-the-input-features">
<h2>Compute a hierarchical clustering of the input features<a class="headerlink" href="#Compute-a-hierarchical-clustering-of-the-input-features" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">partition_tree</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">partition_tree</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sp</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">dendrogram</span><span class="p">(</span><span class="n">partition_tree</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Hierarchical Clustering Dendrogram&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;feature&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_6_0.png" src="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_6_0.png" />
</div>
</div>
</section>
<section id="Explain-the-instance">
<h2>Explain the instance<a class="headerlink" href="#Explain-the-instance" title="Link to this heading"></a></h2>
<p>To demonstrate the new behaviour of the CoalitionExplainer and check if it works correctly we can use the ExactExplainer and PartitionExplainer methods</p>
<p>Theoretically if we pass a flat hierarchy to CoalitionExplainer it should return the same result as the ExactExplainer.</p>
<p>If we turn the linkage matrix PartitionExplainer uses to a dictionary and pass it to the CoalitionExplainer it should return the exact same result as the Partition Explainer</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># function to turn the linkage matrix to a dictionary</span>
<span class="k">def</span> <span class="nf">build_partition_hierarchy</span><span class="p">(</span><span class="n">linkage</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">cluster_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Initialize leaves</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">cluster_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># Build clusters</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">linkage</span><span class="p">):</span>
        <span class="n">idx1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">idx2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">cluster_id</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">i</span>  <span class="c1"># New cluster index</span>

        <span class="c1"># Create cluster names</span>
        <span class="k">if</span> <span class="n">idx1</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">cluster_dict</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cluster_</span><span class="si">{</span><span class="n">idx1</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">idx2</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">cluster_dict</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cluster_</span><span class="si">{</span><span class="n">idx2</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Create the new cluster</span>
        <span class="n">cluster_dict</span><span class="p">[</span><span class="n">cluster_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">left</span><span class="p">:</span> <span class="n">cluster_dict</span><span class="p">[</span><span class="n">idx1</span><span class="p">],</span> <span class="n">right</span><span class="p">:</span> <span class="n">cluster_dict</span><span class="p">[</span><span class="n">idx2</span><span class="p">]}</span>

    <span class="c1"># The root cluster</span>
    <span class="n">root_cluster_id</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">linkage</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;cluster_</span><span class="si">{</span><span class="n">root_cluster_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">cluster_dict</span><span class="p">[</span><span class="n">root_cluster_id</span><span class="p">]}</span>


<span class="n">hierarchy_binary</span> <span class="o">=</span> <span class="n">build_partition_hierarchy</span><span class="p">(</span><span class="n">partition_tree</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we can also create a flat hierarchy and a couple non-binary hierarchies to test the method.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># exact partition hierarchy flat</span>
<span class="n">hierarchy_flat</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;AveOccup&quot;</span><span class="p">:</span> <span class="s2">&quot;AveOccup&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MedInc&quot;</span><span class="p">:</span> <span class="s2">&quot;MedInc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Longitude&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Population&quot;</span><span class="p">:</span> <span class="s2">&quot;Population&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HouseAge&quot;</span><span class="p">:</span> <span class="s2">&quot;HouseAge&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Latitude&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AveBedrms&quot;</span><span class="p">:</span> <span class="s2">&quot;AveBedrms&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AveRooms&quot;</span><span class="p">:</span> <span class="s2">&quot;AveRooms&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># custom partition</span>
<span class="n">hierarchy_nonbinary</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;HouseCharacteristics&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;AveBedrms&quot;</span><span class="p">:</span> <span class="s2">&quot;AveBedrms&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AveRooms&quot;</span><span class="p">:</span> <span class="s2">&quot;AveRooms&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AveOccup&quot;</span><span class="p">:</span> <span class="s2">&quot;AveOccup&quot;</span><span class="p">,</span>
        <span class="s2">&quot;HouseAge&quot;</span><span class="p">:</span> <span class="s2">&quot;HouseAge&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;Area&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;Location&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;Longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Longitude&quot;</span><span class="p">},</span>
        <span class="s2">&quot;Neighbours&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;MedInc&quot;</span><span class="p">:</span> <span class="s2">&quot;MedInc&quot;</span><span class="p">,</span> <span class="s2">&quot;Population&quot;</span><span class="p">:</span> <span class="s2">&quot;Population&quot;</span><span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>
<span class="c1"># custom partition</span>
<span class="n">hierarchy_nonbinary2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Activity&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;MedInc&quot;</span><span class="p">:</span> <span class="s2">&quot;MedInc&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AveOccup&quot;</span><span class="p">:</span> <span class="s2">&quot;AveOccup&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Population&quot;</span><span class="p">:</span> <span class="s2">&quot;Population&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;Material&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;AveBedrms&quot;</span><span class="p">:</span> <span class="s2">&quot;AveBedrms&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AveRooms&quot;</span><span class="p">:</span> <span class="s2">&quot;AveRooms&quot;</span><span class="p">,</span>
        <span class="s2">&quot;HouseAge&quot;</span><span class="p">:</span> <span class="s2">&quot;HouseAge&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;Location&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;Longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Longitude&quot;</span><span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Now we can test the Coalition method and see how it perfroms. Is it correct in extending the Shapley value methods? How does it perform in terms of speed compared to the other methods?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Exact Shap values</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">exact_explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">ExactExplainer</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
<span class="n">exact_shap_values</span> <span class="o">=</span> <span class="n">exact_explainer</span><span class="p">(</span><span class="n">references</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exact Shap values computed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

<span class="c1"># Tree Shap values</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">tree_explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
<span class="n">tree_shap_values</span> <span class="o">=</span> <span class="n">tree_explainer</span><span class="p">(</span><span class="n">references</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tree Shap values computed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

<span class="c1"># Old binary winter values</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">masker_explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">PartitionExplainer</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
<span class="n">binary_winter_values</span> <span class="o">=</span> <span class="n">masker_explainer</span><span class="p">(</span><span class="n">references</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Binary Winter values computed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

<span class="c1"># We can precompute the masker making the computation faster</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="c1"># build a masker from partition tree</span>
<span class="n">masker</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">maskers</span><span class="o">.</span><span class="n">Partition</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">clustering</span><span class="o">=</span><span class="n">partition_tree</span><span class="p">)</span>
<span class="n">masker_explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">PartitionExplainer</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> <span class="n">masker</span><span class="p">)</span>
<span class="n">masker_winter_values</span> <span class="o">=</span> <span class="n">masker_explainer</span><span class="p">(</span><span class="n">references</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Binary Winter values specifying the tree computed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>


<span class="c1"># Shapley values corresponding to flat hierarchy</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">partition_masker</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">maskers</span><span class="o">.</span><span class="n">Partition</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">partition_explainer_f</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">CoalitionExplainer</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> <span class="n">partition_masker</span><span class="p">,</span> <span class="n">partition_tree</span><span class="o">=</span><span class="n">hierarchy_flat</span><span class="p">)</span>
<span class="n">partition_winter_values_f</span> <span class="o">=</span> <span class="n">partition_explainer_f</span><span class="p">(</span><span class="n">references</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Partition Winter values (flat hierarchy) computed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;The Coalition explainer recreates the ExactExplainer Shapley values:&quot;</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">exact_shap_values</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">partition_winter_values_f</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Recreating the old binary winter values</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">partition_explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">CoalitionExplainer</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> <span class="n">partition_masker</span><span class="p">,</span> <span class="n">partition_tree</span><span class="o">=</span><span class="n">hierarchy_binary</span><span class="p">)</span>
<span class="n">partition_winter_values_b</span> <span class="o">=</span> <span class="n">partition_explainer</span><span class="p">(</span><span class="n">references</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Partition Winter values (binary hierarchy) computed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;The Coalition explainer recreates the PartitionExplainer Winter values:&quot;</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">masker_winter_values</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">partition_winter_values_b</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
<span class="p">)</span>


<span class="c1"># Shapley values for non-binary hierarchy</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">partition_explainer_nb</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">PartitionExplainer</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> <span class="n">partition_masker</span><span class="p">,</span> <span class="n">partition_tree</span><span class="o">=</span><span class="n">hierarchy_nonbinary</span><span class="p">)</span>
<span class="n">partition_winter_values_nb</span> <span class="o">=</span> <span class="n">partition_explainer_nb</span><span class="p">(</span><span class="n">references</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Partition Winter values (non-binary hierarchy) computed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

<span class="c1"># Shapley values for another non-binary hierarchy</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">partition_explainer_nb2</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">PartitionExplainer</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> <span class="n">partition_masker</span><span class="p">,</span> <span class="n">partition_tree</span><span class="o">=</span><span class="n">hierarchy_nonbinary2</span><span class="p">)</span>
<span class="n">partition_winter_values_nb2</span> <span class="o">=</span> <span class="n">partition_explainer_nb2</span><span class="p">(</span><span class="n">references</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Partition Winter values (non-binary hierarchy 2) computed in </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
ExactExplainer explainer: 100it [00:10,  2.52s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exact Shap values computed in 10.06 seconds
Tree Shap values computed in 0.35 seconds
Binary Winter values computed in 4.85 seconds
Binary Winter values specifying the tree computed in 2.14 seconds
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
CoalitionExplainer explainer: 100it [00:24,  2.34it/s]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Partition Winter values (flat hierarchy) computed in 24.81 seconds
The Coalition explainer recreates the ExactExplainer Shapley values: True
Partition Winter values (binary hierarchy) computed in 4.98 seconds
The Coalition explainer recreates the PartitionExplainer Winter values: True
Partition Winter values (non-binary hierarchy) computed in 3.88 seconds
Partition Winter values (non-binary hierarchy 2) computed in 3.98 seconds
</pre></div></div>
</div>
</section>
<section id="Compare-to-Tree-SHAP">
<h2>Compare to Tree SHAP<a class="headerlink" href="#Compare-to-Tree-SHAP" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot the SHAP values with enhanced visibility</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">exact_shap_values</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Exact SHAP&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">tree_shap_values</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Tree SHAP&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">binary_winter_values</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Binary Partition SHAP&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">partition_winter_values_b</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Custom Partition SHAP&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">partition_winter_values_b</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-.&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Custom Partition SHAP&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
<span class="p">)</span>


<span class="c1"># Adding title and labels with increased font sizes</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Comparison of SHAP Values&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Feature Index&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;SHAP Value&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="c1"># Customizing the legend for better readability</span>
<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">by_label</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
    <span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
    <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
    <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">borderpad</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Adding a grid for better readability</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="c1"># Adding a light grey background</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;whitesmoke&quot;</span><span class="p">)</span>

<span class="c1"># Adding a horizontal line at y=0 for reference</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Display the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_15_0.png" src="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_15_0.png" />
</div>
</div>
<p>Partition SHAP values using a partition tree are nice estimation of SHAP values. The partition tree is a good way to reduce the number of input features and speed up the computation.</p>
<p>The thinking for why the attributions are so close to the Shapley values is that for each feature the marginal is computed to all the other features masked as well as all of them unmasked which bound the feature’s attribution.</p>
</section>
<section id="Plots-to-explain-the-instance">
<h2>Plots to explain the instance<a class="headerlink" href="#Plots-to-explain-the-instance" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The exact Shap values</span>
<span class="n">shap</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">waterfall</span><span class="p">(</span><span class="n">exact_shap_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">shap</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">waterfall</span><span class="p">(</span><span class="n">tree_shap_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">shap</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">waterfall</span><span class="p">(</span><span class="n">partition_winter_values_f</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># This should match the previous</span>


<span class="c1"># Binary Winter values</span>
<span class="n">shap</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">waterfall</span><span class="p">(</span><span class="n">binary_winter_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Binary Winter values specifying the partition_tree</span>
<span class="n">shap</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">waterfall</span><span class="p">(</span><span class="n">masker_winter_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Partition Winter values (binary hierarchy but with the new method)</span>
<span class="n">shap</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">waterfall</span><span class="p">(</span><span class="n">partition_winter_values_b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># This should match the previous</span>


<span class="c1"># Partition Winter values (non-binary hierarchy)</span>
<span class="n">shap</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">waterfall</span><span class="p">(</span><span class="n">partition_winter_values_nb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="c1"># Partition Winter values (non-binary hierarchy)</span>
<span class="n">shap</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">waterfall</span><span class="p">(</span><span class="n">partition_winter_values_nb2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_18_0.png" src="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_18_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_18_1.png" src="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_18_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_18_2.png" src="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_18_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_18_3.png" src="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_18_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_18_4.png" src="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_18_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_18_5.png" src="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_18_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_18_6.png" src="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_18_6.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_18_7.png" src="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_18_7.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_nodes_edges</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">parent_name</span><span class="p">,</span> <span class="n">parent_dict</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parent_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">parent_name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">add_nodes_edges</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">parent_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">hierarchy_pos</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">vert_gap</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">vert_loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xcenter</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">_hierarchy_pos</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">vert_gap</span><span class="p">,</span> <span class="n">vert_loc</span><span class="p">,</span> <span class="n">xcenter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pos</span>


<span class="k">def</span> <span class="nf">_hierarchy_pos</span><span class="p">(</span>
    <span class="n">G</span><span class="p">,</span>
    <span class="n">root</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">vert_gap</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">vert_loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">xcenter</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">parsed</span><span class="o">=</span><span class="p">[],</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">{</span><span class="n">root</span><span class="p">:</span> <span class="p">(</span><span class="n">xcenter</span><span class="p">,</span> <span class="n">vert_loc</span><span class="p">)}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pos</span><span class="p">[</span><span class="n">root</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xcenter</span><span class="p">,</span> <span class="n">vert_loc</span><span class="p">)</span>

    <span class="n">children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span> <span class="ow">and</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">children</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>
        <span class="n">nextx</span> <span class="o">=</span> <span class="n">xcenter</span> <span class="o">-</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">dx</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">nextx</span> <span class="o">+=</span> <span class="n">dx</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">_hierarchy_pos</span><span class="p">(</span>
                <span class="n">G</span><span class="p">,</span>
                <span class="n">child</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span>
                <span class="n">vert_gap</span><span class="o">=</span><span class="n">vert_gap</span><span class="p">,</span>
                <span class="n">vert_loc</span><span class="o">=</span><span class="n">vert_loc</span> <span class="o">-</span> <span class="n">vert_gap</span><span class="p">,</span>
                <span class="n">xcenter</span><span class="o">=</span><span class="n">nextx</span><span class="p">,</span>
                <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
                <span class="n">parent</span><span class="o">=</span><span class="n">root</span><span class="p">,</span>
                <span class="n">parsed</span><span class="o">=</span><span class="n">parsed</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">pos</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">root_name</span> <span class="o">=</span> <span class="s2">&quot;Root&quot;</span>
<span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">root_name</span><span class="p">)</span>
<span class="n">add_nodes_edges</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">root_name</span><span class="p">,</span> <span class="n">hierarchy_flat</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">hierarchy_pos</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">root_name</span><span class="p">)</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span>
    <span class="n">G</span><span class="p">,</span>
    <span class="n">pos</span><span class="p">,</span>
    <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">arrows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">node_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">node_color</span><span class="o">=</span><span class="s2">&quot;skyblue&quot;</span><span class="p">,</span>
    <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">font_weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
    <span class="n">edge_color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Shapley value/Individual coalitions&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

<span class="c1"># Plot the first hierarchical tree</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">root_name</span> <span class="o">=</span> <span class="s2">&quot;Root&quot;</span>
<span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">root_name</span><span class="p">)</span>
<span class="n">add_nodes_edges</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">root_name</span><span class="p">,</span> <span class="n">hierarchy_binary</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">hierarchy_pos</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">root_name</span><span class="p">)</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span>
    <span class="n">G</span><span class="p">,</span>
    <span class="n">pos</span><span class="p">,</span>
    <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">arrows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">node_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">node_color</span><span class="o">=</span><span class="s2">&quot;skyblue&quot;</span><span class="p">,</span>
    <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">font_weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
    <span class="n">edge_color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Binary clustering partition tree&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

<span class="c1"># Plot the second hierarchical tree</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">root_name</span> <span class="o">=</span> <span class="s2">&quot;Root&quot;</span>
<span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">root_name</span><span class="p">)</span>
<span class="n">add_nodes_edges</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">root_name</span><span class="p">,</span> <span class="n">hierarchy_nonbinary</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">hierarchy_pos</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">root_name</span><span class="p">)</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span>
    <span class="n">G</span><span class="p">,</span>
    <span class="n">pos</span><span class="p">,</span>
    <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">arrows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">node_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">node_color</span><span class="o">=</span><span class="s2">&quot;skyblue&quot;</span><span class="p">,</span>
    <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">font_weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
    <span class="n">edge_color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Custom partition tree&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

<span class="c1"># Plot the third hierarchical tree</span>


<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_19_0.png" src="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_19_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">36</span><span class="p">))</span>

<span class="c1"># Plot the first hierarchical tree</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">root_name</span> <span class="o">=</span> <span class="s2">&quot;Root&quot;</span>
<span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">root_name</span><span class="p">)</span>
<span class="n">add_nodes_edges</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">root_name</span><span class="p">,</span> <span class="n">hierarchy_flat</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">hierarchy_pos</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">root_name</span><span class="p">)</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span>
    <span class="n">G</span><span class="p">,</span>
    <span class="n">pos</span><span class="p">,</span>
    <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">arrows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">node_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">node_color</span><span class="o">=</span><span class="s2">&quot;skyblue&quot;</span><span class="p">,</span>
    <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">font_weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
    <span class="n">edge_color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Shapley value/Individual coalitions&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

<span class="c1"># Plot the second hierarchical tree</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">root_name</span> <span class="o">=</span> <span class="s2">&quot;Root&quot;</span>
<span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">root_name</span><span class="p">)</span>
<span class="n">add_nodes_edges</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">root_name</span><span class="p">,</span> <span class="n">hierarchy_binary</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">hierarchy_pos</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">root_name</span><span class="p">)</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span>
    <span class="n">G</span><span class="p">,</span>
    <span class="n">pos</span><span class="p">,</span>
    <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">arrows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">node_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">node_color</span><span class="o">=</span><span class="s2">&quot;skyblue&quot;</span><span class="p">,</span>
    <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">font_weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
    <span class="n">edge_color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Binary clustering partition tree&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

<span class="c1"># Plot the third hierarchical tree</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
<span class="n">root_name</span> <span class="o">=</span> <span class="s2">&quot;Root&quot;</span>
<span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">root_name</span><span class="p">)</span>
<span class="n">add_nodes_edges</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">root_name</span><span class="p">,</span> <span class="n">hierarchy_nonbinary</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">hierarchy_pos</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">root_name</span><span class="p">)</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span>
    <span class="n">G</span><span class="p">,</span>
    <span class="n">pos</span><span class="p">,</span>
    <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">arrows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">node_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">node_color</span><span class="o">=</span><span class="s2">&quot;skyblue&quot;</span><span class="p">,</span>
    <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">font_weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
    <span class="n">edge_color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Custom partition tree&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

<span class="c1"># Plot the SHAP waterfall plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">shap</span><span class="o">.</span><span class="n">waterfall_plot</span><span class="p">(</span><span class="n">exact_shap_values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Exact SHAP Values&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">shap</span><span class="o">.</span><span class="n">waterfall_plot</span><span class="p">(</span><span class="n">masker_winter_values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Binary Clustering Winter Values&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">shap</span><span class="o">.</span><span class="n">waterfall_plot</span><span class="p">(</span><span class="n">partition_winter_values_nb2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Custom Partition Winter Values&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="c1"># Adjust layout</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># Save the figure</span>
<span class="c1"># plt.savefig(r&#39;C:\Users\azabe\Documents\GitHub\Winter_values\winter_values\hierarchical_trees_and_shap_plots.png&#39;)</span>

<span class="c1"># Show the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_20_0.png" src="../../../_images/example_notebooks_tabular_examples_model_agnostic_Simple_California_Demo_20_0.png" />
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Multioutput%20Regression%20SHAP.html" class="btn btn-neutral float-left" title="SHAP Values for Multi-Output Regression Models" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Simple%20Kernel%20SHAP.html" class="btn btn-neutral float-right" title="Simple Kernel SHAP" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, Scott Lundberg.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>